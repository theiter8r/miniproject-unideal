// ============================================
// Unideal â€” Complete Database Schema
// 14 models, all enums, relations, and indexes
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum VerificationStatus {
  UNVERIFIED
  PENDING
  VERIFIED
  REJECTED
}

enum ListingType {
  SELL
  RENT
  BOTH
}

enum ItemCondition {
  NEW
  LIKE_NEW
  USED
  HEAVILY_USED
}

enum ItemStatus {
  AVAILABLE
  RESERVED
  SOLD
  RENTED
  ARCHIVED
}

enum TransactionStatus {
  PENDING
  CAPTURED
  RESERVED
  SETTLED
  DISPUTED
  REFUNDED
  CANCELLED
  EXPIRED
}

enum TransactionType {
  BUY
  RENT
}

enum WalletTransactionType {
  CREDIT_ESCROW
  RELEASE_ESCROW
  WITHDRAWAL
  REFUND_DEBIT
}

enum MessageType {
  TEXT
  LOCATION
  IMAGE
  SYSTEM
}

enum NotificationType {
  VERIFICATION_APPROVED
  VERIFICATION_REJECTED
  NEW_MESSAGE
  PAYMENT_RECEIVED
  FUNDS_RELEASED
  ITEM_SOLD
  TRANSACTION_UPDATE
  REVIEW_RECEIVED
  SYSTEM
}

enum ReportReason {
  SPAM
  FAKE_LISTING
  INAPPROPRIATE
  SCAM
  HARASSMENT
  OTHER
}

enum ReportStatus {
  PENDING
  REVIEWED
  ACTION_TAKEN
  DISMISSED
}

// ============================================
// MODELS
// ============================================

model College {
  id             String   @id @default(cuid())
  name           String   @unique
  slug           String   @unique
  emailDomain    String   @unique
  city           String
  state          String
  campusLat      Float?
  campusLng      Float?
  campusBoundary Json?
  logoUrl        String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  users User[]
  items Item[]
}

model User {
  id                 String             @id @default(cuid())
  clerkId            String             @unique
  email              String             @unique
  fullName           String
  phone              String?
  avatarUrl          String?
  collegeId          String?
  verificationStatus VerificationStatus @default(UNVERIFIED)
  isAdmin            Boolean            @default(false)
  isBanned           Boolean            @default(false)
  onboardingComplete Boolean            @default(false)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  college              College?        @relation(fields: [collegeId], references: [id])
  wallet               Wallet?
  items                Item[]
  buyerTransactions    Transaction[]   @relation("BuyerTransactions")
  sellerTransactions   Transaction[]   @relation("SellerTransactions")
  favorites            Favorite[]
  reviewsGiven         Review[]        @relation("ReviewerReviews")
  reviewsReceived      Review[]        @relation("RevieweeReviews")
  verifications        Verification[]
  notifications        Notification[]
  conversationsAsUser1 Conversation[]  @relation("User1Conversations")
  conversationsAsUser2 Conversation[]  @relation("User2Conversations")
  messages             Message[]
  reportsMade          Report[]        @relation("ReporterReports")
  reportsReceived      Report[]        @relation("ReportedUserReports")

  @@index([clerkId])
  @@index([collegeId])
  @@index([email])
}

model Wallet {
  id            String              @id @default(cuid())
  userId        String              @unique
  balance       Decimal             @default(0) @db.Decimal(10, 2)
  frozenBalance Decimal             @default(0) @db.Decimal(10, 2)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions WalletTransaction[]
}

model WalletTransaction {
  id          String                @id @default(cuid())
  walletId    String
  type        WalletTransactionType
  amount      Decimal               @db.Decimal(10, 2)
  description String
  referenceId String?
  createdAt   DateTime              @default(now())

  wallet Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
}

model Category {
  id       Int      @id @default(autoincrement())
  name     String   @unique
  slug     String   @unique
  iconName String
  createdAt DateTime @default(now())

  items Item[]
}

model Item {
  id              String        @id @default(cuid())
  sellerId        String
  collegeId       String
  categoryId      Int
  title           String
  description     String?
  listingType     ListingType
  sellPrice       Decimal?      @db.Decimal(10, 2)
  rentPricePerDay Decimal?      @db.Decimal(10, 2)
  images          String[]
  condition       ItemCondition
  status          ItemStatus    @default(AVAILABLE)
  pickupLocation  String?
  pickupLat       Float?
  pickupLng       Float?
  viewCount       Int           @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  seller       User          @relation(fields: [sellerId], references: [id])
  college      College       @relation(fields: [collegeId], references: [id])
  category     Category      @relation(fields: [categoryId], references: [id])
  transactions Transaction[]
  favorites    Favorite[]
  reports      Report[]      @relation("ReportedItemReports")

  @@index([sellerId])
  @@index([collegeId])
  @@index([status])
  @@index([categoryId])
  @@index([createdAt])
}

model Transaction {
  id                String            @id @default(cuid())
  itemId            String
  buyerId           String
  sellerId          String
  type              TransactionType
  status            TransactionStatus @default(PENDING)
  amount            Decimal           @db.Decimal(10, 2)
  razorpayOrderId   String?           @unique
  razorpayPaymentId String?           @unique
  razorpaySignature String?
  rentStartDate     DateTime?
  rentEndDate       DateTime?
  buyerMessage      String?
  sellerNotes       String?
  settledAt         DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  item         Item          @relation(fields: [itemId], references: [id])
  buyer        User          @relation("BuyerTransactions", fields: [buyerId], references: [id])
  seller       User          @relation("SellerTransactions", fields: [sellerId], references: [id])
  conversation Conversation?
  reviews      Review[]

  @@index([buyerId])
  @@index([sellerId])
  @@index([razorpayOrderId])
  @@index([status])
}

model Conversation {
  id              String    @id @default(cuid())
  transactionId   String    @unique
  user1Id         String
  user2Id         String
  ablyChannelName String    @unique
  lastMessageAt   DateTime?
  createdAt       DateTime  @default(now())

  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  user1       User        @relation("User1Conversations", fields: [user1Id], references: [id])
  user2       User        @relation("User2Conversations", fields: [user2Id], references: [id])
  messages    Message[]

  @@index([user1Id])
  @@index([user2Id])
}

model Message {
  id             String      @id @default(cuid())
  conversationId String
  senderId       String
  type           MessageType @default(TEXT)
  content        String
  isRead         Boolean     @default(false)
  createdAt      DateTime    @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id])

  @@index([conversationId])
  @@index([senderId])
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  itemId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  item Item @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([userId, itemId])
  @@index([userId])
}

model Review {
  id            String   @id @default(cuid())
  transactionId String
  reviewerId    String
  revieweeId    String
  rating        Int
  comment       String?
  createdAt     DateTime @default(now())

  transaction Transaction @relation(fields: [transactionId], references: [id])
  reviewer    User        @relation("ReviewerReviews", fields: [reviewerId], references: [id])
  reviewee    User        @relation("RevieweeReviews", fields: [revieweeId], references: [id])

  @@unique([transactionId, reviewerId])
  @@index([revieweeId])
}

model Verification {
  id             String             @id @default(cuid())
  userId         String
  idCardImageUrl String
  status         VerificationStatus @default(PENDING)
  reviewerNotes  String?
  reviewedBy     String?
  reviewedAt     DateTime?
  createdAt      DateTime           @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  body      String
  data      Json?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
}

model Report {
  id             String       @id @default(cuid())
  reporterId     String
  reportedUserId String?
  reportedItemId String?
  reason         ReportReason
  description    String?
  status         ReportStatus @default(PENDING)
  adminNotes     String?
  reviewedBy     String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  reporter     User  @relation("ReporterReports", fields: [reporterId], references: [id])
  reportedUser User? @relation("ReportedUserReports", fields: [reportedUserId], references: [id])
  reportedItem Item? @relation("ReportedItemReports", fields: [reportedItemId], references: [id])

  @@index([status])
}
